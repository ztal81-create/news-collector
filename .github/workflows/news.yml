import os
import requests
from bs4 import BeautifulSoup

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
URL = "https://news.ycombinator.com/newest"
HISTORY_FILE = "sent_news.txt"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram –∏–∑ GitHub Secrets
BOT_TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN")
CHAT_ID = os.environ.get("TELEGRAM_CHAT_ID")

def load_history():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –∏–∑ —Ñ–∞–π–ª–∞."""
    if os.path.exists(HISTORY_FILE):
        with open(HISTORY_FILE, "r", encoding="utf-8") as f:
            return set(line.strip() for line in f)
    return set()

def save_to_history(link):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É –≤ —Ñ–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏."""
    with open(HISTORY_FILE, "a", encoding="utf-8") as f:
        f.write(link + "\n")

def send_telegram_message(message):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram."""
    if not BOT_TOKEN or not CHAT_ID:
        print("–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –∏–ª–∏ ID —á–∞—Ç–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã.")
        return

    url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    payload = {
        "chat_id": CHAT_ID,
        "text": message,
        "parse_mode": "HTML"
    }
    
    try:
        response = requests.post(url, json=payload)
        response.raise_for_status()
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram: {e}")

def collect_news():
    print(f"–ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ –¥–ª—è {URL}...")
    sent_links = load_history()
    new_items_found = 0

    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36"
    }

    try:
        response = requests.get(URL, headers=headers, timeout=10)
        response.raise_for_status()
        soup = BeautifulSoup(response.text, "lxml")

        # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–æ–≤–æ—Å—Ç–µ–π (–¥–ª—è Hacker News —ç—Ç–æ tr —Å –∫–ª–∞—Å—Å–æ–º athing)
        items = soup.select("tr.athing")

        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –Ω–æ–≤–æ—Å—Ç–µ–π, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
        for item in items[:10]:
            title_element = item.select_one(".titleline > a")
            if not title_element:
                continue

            title = title_element.text
            link = title_element['href']

            # –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ—ë
            if link not in sent_links:
                print(f"–ù–æ–≤–∞—è –Ω–æ–≤–æ—Å—Ç—å: {title}")
                message = f"<b>üÜï {title}</b>\n\nüîó <a href='{link}'>–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ</a>"
                
                send_telegram_message(message)
                save_to_history(link)
                new_items_found += 1
            else:
                print(f"–ü—Ä–æ–ø—É—â–µ–Ω–æ (—É–∂–µ –±—ã–ª–æ): {title[:30]}...")

        print(f"–ì–æ—Ç–æ–≤–æ. –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π: {new_items_found}")

    except Exception as e:
        print(f"–û–±—â–∞—è –æ—à–∏–±–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞: {e}")

if __name__ == "__main__":
    collect_news()
